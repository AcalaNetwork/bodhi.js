name: Unit Tests
on:
  push:
    paths-ignore:
      - '**/README.md'

jobs:
  test-bodhi:
    runs-on: ubuntu-latest
    steps:
      - name: checkout
        uses: actions/checkout@v2
        with:
          submodules: recursive

      - name: setup node env
        uses: actions/setup-node@v2
        with:
          node-version: '14.16.0'

      - name: install dependencies
        run: node common/scripts/install-run-rush.js update

      - name: build
        run: node common/scripts/install-run-rush.js build -t @acala-network/bodhi

      - name: test
        run: cd bodhi && yarn test
        env:
          NPM_TOKEN: doesnt-matter

  test-eth-provider:
    runs-on: ubuntu-latest
    steps:
      - name: checkout
        uses: actions/checkout@v2
        with:
          submodules: recursive

      - name: setup node env
        uses: actions/setup-node@v2
        with:
          node-version: '14.16.0'

      - name: install dependencies
        run: node common/scripts/install-run-rush.js update

      - name: build
        run: node common/scripts/install-run-rush.js build -t @acala-network/eth-providers

      - name: test
        run: cd eth-providers && yarn test

  test-eth-transactions:
    runs-on: ubuntu-latest
    steps:
      - name: checkout
        uses: actions/checkout@v2
        with:
          submodules: recursive

      - name: setup node env
        uses: actions/setup-node@v2
        with:
          node-version: '14.16.0'

      - name: install dependencies
        run: node common/scripts/install-run-rush.js update

      - name: build
        run: node common/scripts/install-run-rush.js build -t @acala-network/eth-transactions

      - name: test
        run: cd eth-transactions && yarn test

  test-eth-rpc-adapter:
    runs-on: ubuntu-latest
    steps:
      - name: checkout
        uses: actions/checkout@v2
        with:
          submodules: recursive

      - name: setup node env
        uses: actions/setup-node@v2
        with:
          node-version: '14.16.0'

      - name: install dependencies
        run: node common/scripts/install-run-rush.js update

      - name: build
        run: node common/scripts/install-run-rush.js build -t @acala-network/eth-rpc-adapter

      - name: test
        run: cd eth-rpc-adapter && yarn test

  test-evm-subql:
    runs-on: ubuntu-latest
    steps:
      - name: checkout
        uses: actions/checkout@v2
        with:
          submodules: recursive

      - name: setup node env
        uses: actions/setup-node@v2
        with:
          node-version: '14.16.0'

      - name: install dependencies
        run: node common/scripts/install-run-rush.js update

      - name: build
        run: node common/scripts/install-run-rush.js build -t @acala-network/eth-providers

      - name: install and build (evm-subql specific)
        run: cd evm-subql && yarn && yarn build

      - name: test
        run: cd evm-subql && yarn test

  test-evm-waffle-examples:
    runs-on: ubuntu-latest
    steps:
      - name: checkout
        uses: actions/checkout@v2
        with:
          submodules: recursive

      - name: setup node env
        uses: actions/setup-node@v2
        with:
          node-version: '14.16.0'

      - name: install dependencies
        run: node common/scripts/install-run-rush.js update

      - name: build
        run: node common/scripts/install-run-rush.js build

      - name: build hello world
        run: node common/scripts/install-run-rush.js build -t waffle-tutorial-hello-world

      - name: build echo
        run: node common/scripts/install-run-rush.js build -t waffle-tutorial-echo

      - name: build token
        run: node common/scripts/install-run-rush.js build -t waffle-tutorial-token

      - name: build nft
        run: node common/scripts/install-run-rush.js build -t waffle-tutorial-nft

      - name: test
        run: echo "TODO" # use public mandala for testing

  test-evm-hardhat-examples:
    runs-on: ubuntu-latest
    steps:
      - name: checkout
        uses: actions/checkout@v2
        with:
          submodules: recursive

      - name: setup node env
        uses: actions/setup-node@v2
        with:
          node-version: '14.16.0'

      - name: install dependencies
        run: node common/scripts/install-run-rush.js update

      - name: build hello world
        run: node common/scripts/install-run-rush.js build -t hardhat-tutorial-hello-world

      - name: build echo
        run: node common/scripts/install-run-rush.js build -t hardhat-tutorial-echo

      - name: build token
        run: node common/scripts/install-run-rush.js build -t hardhat-tutorial-token

      - name: build nft
        run: node common/scripts/install-run-rush.js build -t hardhat-tutorial-nft

      - name: test
        run: echo "TODO" # use public mandala for testing

  test-evm-truffle-examples:
    runs-on: ubuntu-latest
    steps:
      - name: checkout
        uses: actions/checkout@v2
        with:
          submodules: recursive

      - name: setup node env
        uses: actions/setup-node@v2
        with:
          node-version: '14.16.0'

      - name: install dependencies
        run: node common/scripts/install-run-rush.js update

      - name: build hello world
        run: node common/scripts/install-run-rush.js build -t truffle-tutorial-hello-world

      - name: build echo
        run: node common/scripts/install-run-rush.js build -t truffle-tutorial-echo

      - name: build token
        run: node common/scripts/install-run-rush.js build -t truffle-tutorial-token

      - name: build nft
        run: node common/scripts/install-run-rush.js build -t truffle-tutorial-nft

      - name: test
        run: echo "TODO" # use public mandala for testing
