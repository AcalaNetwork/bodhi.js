name: Unit Tests
on:
  push:
    paths-ignore:
      - '**/README.md'

jobs:
  test-bodhi:
    runs-on: ubuntu-latest
    steps:
      - name: checkout
        uses: actions/checkout@v2
        with:
          submodules: recursive

      - name: setup node env
        uses: actions/setup-node@v2
        with:
          node-version: '14.16.0'

      - name: install dependencies
        run: node common/scripts/install-run-rush.js update

      - name: build
        run: node common/scripts/install-run-rush.js build -t @acala-network/bodhi

      - name: test
        run: cd bodhi && yarn test
        env:
          NPM_TOKEN: doesnt-matter

  test-eth-provider:
    runs-on: ubuntu-latest
    steps:
      - name: checkout
        uses: actions/checkout@v2
        with:
          submodules: recursive

      - name: setup node env
        uses: actions/setup-node@v2
        with:
          node-version: '14.16.0'

      - name: install dependencies
        run: node common/scripts/install-run-rush.js update

      - name: build
        run: node common/scripts/install-run-rush.js build -t @acala-network/eth-providers

      - name: test
        run: cd eth-providers && yarn test

  test-eth-transactions:
    runs-on: ubuntu-latest
    steps:
      - name: checkout
        uses: actions/checkout@v2
        with:
          submodules: recursive

      - name: setup node env
        uses: actions/setup-node@v2
        with:
          node-version: '14.16.0'

      - name: install dependencies
        run: node common/scripts/install-run-rush.js update

      - name: build
        run: node common/scripts/install-run-rush.js build -t @acala-network/eth-transactions

      - name: test
        run: cd eth-transactions && yarn test

  test-eth-rpc-adapter:
    runs-on: ubuntu-latest
    steps:
      - name: checkout
        uses: actions/checkout@v2
        with:
          submodules: recursive

      - name: setup node env
        uses: actions/setup-node@v2
        with:
          node-version: '14.16.0'

      - name: install dependencies
        run: node common/scripts/install-run-rush.js update

      - name: build
        run: node common/scripts/install-run-rush.js build -t @acala-network/eth-rpc-adapter

      - name: test
        run: cd eth-rpc-adapter && yarn test

  test-evm-subql:
    runs-on: ubuntu-latest
    steps:
      - name: checkout
        uses: actions/checkout@v2
        with:
          submodules: recursive

      - name: setup node env
        uses: actions/setup-node@v2
        with:
          node-version: '14.16.0'

      - name: install dependencies
        run: node common/scripts/install-run-rush.js update

      - name: build
        run: node common/scripts/install-run-rush.js build -t @acala-network/eth-providers

      - name: install and build (evm-subql specific)
        run: cd evm-subql && yarn && yarn build

      - name: test
        run: cd evm-subql && yarn test

  test-waffle-examples:
    runs-on: ubuntu-latest
    steps:
      - name: checkout
        uses: actions/checkout@v2
        with:
          submodules: recursive

      - name: setup node env
        uses: actions/setup-node@v2
        with:
          node-version: '14.16.0'

      - name: install dependencies
        run: node common/scripts/install-run-rush.js update

      - name: build
        run: |
          node common/scripts/install-run-rush.js build \
            -t evm-waffle-example-hello-world \
            -t evm-waffle-example-dex \
            -t evm-waffle-example-e2e \
            -t evm-waffle-example-erc20 \
            -t evm-waffle-example-oracle \
            -t evm-waffle-example-state-rent \
            -t evm-waffle-example-arbitrager \
            -t evm-waffle-example-scheduler

  test-waffle-tutorials:
    runs-on: ubuntu-latest
    steps:
      - name: checkout
        uses: actions/checkout@v2
        with:
          submodules: recursive

      - name: setup node env
        uses: actions/setup-node@v2
        with:
          node-version: '14.16.0'

      - name: install dependencies
        run: node common/scripts/install-run-rush.js update

      - name: build
        run: |
          node common/scripts/install-run-rush.js build \
            -t waffle-tutorial-hello-world \
            -t waffle-tutorial-echo \
            -t waffle-tutorial-token \
            -t waffle-tutorial-nft \
            -t waffle-tutorial-precompiled-token
  
  ### TODO: add this back after upgrading bodhi packages
  # test-hardhat-tutorials:
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: checkout
  #       uses: actions/checkout@v2
  #       with:
  #         submodules: recursive

  #     - name: setup node env
  #       uses: actions/setup-node@v2
  #       with:
  #         node-version: '14.16.0'

  #     - name: install dependencies
  #       run: node common/scripts/install-run-rush.js update

  #     - name: build
  #       run: |
  #         node common/scripts/install-run-rush.js build \
  #           -t hardhat-tutorial-hello-world \
  #           -t hardhat-tutorial-echo \
  #           -t hardhat-tutorial-token \
  #           -t hardhat-tutorial-nft \
  #           -t hardhat-tutorial-precompiled-token \
  #           -t hardhat-tutorial-dex

  test-truffle-tutorials:
    runs-on: ubuntu-latest
    steps:
      - name: checkout
        uses: actions/checkout@v2
        with:
          submodules: recursive

      - name: setup node env
        uses: actions/setup-node@v2
        with:
          node-version: '14.16.0'

      - name: install dependencies
        run: node common/scripts/install-run-rush.js update

      - name: build
        run: |
          node common/scripts/install-run-rush.js build \
            -t truffle-tutorial-hello-world \
            -t truffle-tutorial-echo \
            -t truffle-tutorial-token \
            -t truffle-tutorial-nft \
            -t truffle-tutorial-precompiled-token \
            -t truffle-tutorial-dex